{% extends 'base.html' %}
{% block content %}
<div class="main-container tournament-manage-container">
    <div class="tournament-manage-header flex-between">
        <div>
            <h2 class="tournament-manage-title">Manage Tournament</h2>
            <p class="muted-info mb-05">Edit tournament details, control who is playing, and manage fixtures across the
                entire event from one screen.</p>
        </div>
        <a href="{{ url_for('index') }}" class="btn-secondary"><i class="fa-solid fa-house icon-left"></i>Back to
            Dashboard</a>
    </div>

    <section class="manage-card">
        <div class="manage-card-header flex-between">
            <h3 class="manage-card-title">Tournament Details</h3>
            <span class="manage-card-meta">ID #{{ tournament['id'] }}</span>
        </div>
        <form class="tournament-detail-form" method="post"
            action="{{ url_for('edit_tournament', tournament_id=tournament['id']) }}" autocomplete="off">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="intent" value="update_details">
            <div class="details-grid">
                <div class="form-field">
                    <label for="name" class="fw-500">Tournament Name</label>
                    <input type="text" name="name" id="name" value="{{ tournament['name'] }}" required
                        placeholder="e.g. Sydney Open">
                </div>
                <div class="form-field">
                    <label for="date" class="fw-500">Date</label>
                    <input type="date" name="date" id="date" value="{{ tournament['date'] }}" required>
                </div>
                <div class="form-field">
                    <label for="location" class="fw-500">Location</label>
                    <input type="text" name="location" id="location" value="{{ tournament['location'] }}" required
                        placeholder="e.g. Sydney Chess Club">
                </div>
                <div class="form-field">
                    <label for="format" class="fw-500">Format</label>
                    <select name="format" id="format" required>
                        <option value="" disabled>Select format</option>
                        <option value="Swiss" {% if tournament['format']=='Swiss' %}selected{% endif %}>Swiss</option>
                        <option value="Round-robin" {% if tournament['format']=='Round-robin' %}selected{% endif %}>Round-robin
                        </option>
                        <option value="Knockout" {% if tournament['format']=='Knockout' %}selected{% endif %}>Knockout</option>
                    </select>
                </div>
            </div>
            <div class="detail-actions">
                <button type="submit" class="btn-primary"><i class="fa-solid fa-floppy-disk icon-left"></i>Save
                    Details</button>
            </div>
        </form>
    </section>

    <section class="manage-card" id="participants">
        <div class="manage-card-header flex-between">
            <h3 class="manage-card-title">Participants</h3>
            <span class="manage-card-meta">{{ selected_ids|length }} selected</span>
        </div>
        <form method="post" action="{{ url_for('edit_tournament', tournament_id=tournament['id']) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="intent" value="save_participants">
            <div class="flex-end gap-1 mb-05 participant-actions">
                <button type="button" class="btn-secondary select-all-btn">Select All</button>
                <button type="button" class="btn-secondary clear-all-btn">Clear All</button>
                <button type="submit" class="btn-primary save-participants-btn"><i
                        class="fa-solid fa-user-check icon-left"></i>Save
                    Participants</button>
            </div>
            <div class="scrollable-table">
                <table class="tournament-table members-table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in members %}
                        <tr>
                            <td><input type="checkbox" name="participants" value="{{ member['id'] }}" {% if
                                    member['id'] in selected_ids %}checked{% endif %}></td>
                            <td>{{ member['name'] }}</td>
                            <td>{{ member['email'] or '-' }}</td>
                            <td>{{ member['rating'] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </section>

    <section class="manage-card" id="fixtures">
        <div class="manage-card-header flex-between">
            <div>
                <h3 class="manage-card-title">Tournament Fixtures</h3>
                <p class="muted-info mb-05">Generate pairings round-by-round, update results as games finish, and export the
                    entire schedule.</p>
            </div>
            <div class="fixture-actions">
                <form method="post" action="{{ url_for('generate_fixtures', tournament_id=tournament['id']) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn-secondary" {% if not can_generate %}disabled title="{{ generate_disabled_reason }}"{% endif %}>
                        <i class="fa-solid fa-shuffle icon-left"></i>{{ generate_label }}
                    </button>
                </form>
                <form method="post" action="{{ url_for('clear_fixtures', tournament_id=tournament['id']) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn-secondary"><i class="fa-solid fa-eraser icon-left"></i>Clear
                        Fixtures</button>
                </form>
                <a href="{{ url_for('export_fixtures_csv', tournament_id=tournament['id']) }}"
                    class="btn-secondary export-csv-btn"><i class="fa-solid fa-download icon-left"></i>Export CSV</a>
            </div>
        </div>
        {% if tournament_complete %}
        <p class="muted-info fw-600">Tournament complete! Review the final standings below.</p>
        {% endif %}

        {% if round_numbers %}
        <div id="fixtures-anchor"></div>
        {% for round_no in round_numbers %}
        <div class="fixture-round">
            <h4 class="fw-600 mb-05">Round {{ round_no }}</h4>
            <div class="scrollable-table">
                <table class="tournament-table">
                    <thead>
                        <tr>
                            <th>Player 1</th>
                            <th>Player 2</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fixture in fixtures_by_round[round_no] %}
                        <tr>
                            <td>{{ fixture['player1_name'] }}</td>
                            <td>{% if fixture['player2_name'] %}{{ fixture['player2_name'] }}{% else %}BYE{% endif %}</td>
                            <td>
                                {% if fixture['player2_id'] %}
                                <form method="post" class="fixture-result-form"
                                    action="{{ url_for('update_fixture_result', fixture_id=fixture['id']) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <select name="result" onchange="this.form.submit()">
                                        <option value="TBD" {% if fixture['result']=='TBD' %}selected{% endif %}>TBD</option>
                                        <option value="1-0" {% if fixture['result']=='1-0' %}selected{% endif %}>{{ fixture['player1_name'] }} win</option>
                                        <option value="0-1" {% if fixture['result']=='0-1' %}selected{% endif %}>{{ fixture['player2_name'] }} win</option>
                                        {% if tournament['format'] != 'Knockout' %}
                                        <option value="0.5-0.5" {% if fixture['result']=='0.5-0.5' %}selected{% endif %}>Draw</option>
                                        {% endif %}
                                    </select>
                                </form>
                                {% else %}
                                Bye ({{ fixture['player1_name'] }} gains 1 point)
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="muted-info">No fixtures generated yet. Use the {{ generate_label }} button once participants are saved.</p>
        {% endif %}
    </section>

    {% if standings %}
    <section class="manage-card" id="standings">
        <div class="manage-card-header flex-between">
            <h3 class="manage-card-title">Standings</h3>
            <span class="manage-card-meta">Updated automatically as results are entered</span>
        </div>
        <div class="scrollable-table">
            <table class="tournament-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Rating</th>
                        <th>Score</th>
                        <th>Wins</th>
                        <th>Draws</th>
                        <th>Losses</th>
                        <th>Byes</th>
                        <th>Played</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in standings %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ row.player_name }}</td>
                        <td>{{ row.player_rating if row.player_rating is not none else '-' }}</td>
                        <td>{{ '{:g}'.format(row.score) }}</td>
                        <td>{{ row.wins }}</td>
                        <td>{{ row.draws }}</td>
                        <td>{{ row.losses }}</td>
                        <td>{{ row.byes }}</td>
                        <td>{{ row.played }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}
</div>

<script src="{{ url_for('static', filename='js/affectAll.js') }}"></script>
<script src="{{ url_for('static', filename='js/scrollToFixtures.js') }}"></script>
{% endblock %}
